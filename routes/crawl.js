var express = require('express');
var request = require('request')
var cheerio = require('cheerio')
var fs = require('fs')
var hma = require('hma-proxy-scraper')

var router = express.Router();

// const ips = ["138.197.192.64:65000", "138.197.83.21:8080", "216.56.48.118:9000", "52.55.185.86:3128", "159.203.112.118:3128", "23.94.223.106:80", "54.158.134.115:80", "34.229.144.216:3128", "162.230.215.138:3128", "76.75.55.225:63909", "165.227.124.179:3128", "98.228.67.167:80", "45.79.149.212:3128", "209.163.160.253:8080", "207.201.249.9:8080", "72.169.157.84:87", "184.95.48.104:3128", "208.59.142.52:65103", "104.199.175.52:8080", "50.17.166.167:3128"]
// const ips = ["http://138.197.192.64:65000", "http://138.197.83.21:8080", "http://216.56.48.118:9000", "http://52.55.185.86:3128", "http://159.203.112.118:3128", "http://23.94.223.106:80", "http://54.158.134.115:80", "http://34.229.144.216:3128", "http://162.230.215.138:3128", "http://76.75.55.225:63909", "http://165.227.124.179:3128", "http://98.228.67.167:80", "http://45.79.149.212:3128", "http://209.163.160.253:8080", "http://207.201.249.9:8080", "http://72.169.157.84:87", "http://184.95.48.104:3128", "http://208.59.142.52:65103", "http://104.199.175.52:8080", "http://50.17.166.167:3128"]
// const ips = ['http://159.203.112.118:3128',
//     'http://165.227.124.179:3128',
//     'http://50.17.166.167:3128',
//     'http://216.56.48.118:9000',
//     'http://45.79.149.212:3128',
//     'http://207.201.249.9:8080',
//     'http://209.163.160.253:8080',
//     'http://138.197.192.64:65000',
//     'http://208.59.142.52:65103',
//     'http://138.197.83.21:8080',
//     'http://162.230.215.138:3128']
// const ips = ["http://138.197.192.64:65000"]

// const ips = ["http://139.59.118.0:8080","http://103.21.77.117:8080","http://103.250.144.42:8080","http://202.62.82.74:8080","http://103.220.28.202:8080","http://139.59.13.167:3128","http://45.124.145.34:8080","http://139.59.114.21:8080","http://27.124.52.113:8080","http://223.196.75.63:8080","http://45.115.174.202:8080","http://103.252.186.212:8080","http://182.74.200.200:80","http://45.249.48.124:8080","http://182.74.209.190:3128","http://118.151.209.203:8080","http://103.78.15.102:8080","http://103.56.30.128:8080","http://182.73.76.162:8080","http://103.24.124.81:8080","http://139.59.69.30:3128","http://139.59.77.126:3128","http://103.24.127.197:8080","http://103.240.100.106:8080","http://103.24.108.238:8080","http://72.163.218.146:80","http://182.74.200.201:80","http://124.124.45.3:3128","http://203.115.102.148:8080","http://59.90.100.57:8080","http://103.1.103.4:8080"]
const ips = ["http://139.59.69.30:3128", "http://103.250.144.42:8080", "http://139.59.77.126:3128", "http://118.151.209.203:8080", "http://27.124.52.113:8080", "http://139.59.118.0:8080", "http://45.115.174.202:8080", "http://103.240.100.106:8080", "http://202.62.82.74:8080", "http://103.24.127.197:8080"]

const newips = []


const screenshot = function (html, filename) {
    fs.writeFile(filename, html, function (err) {
        if (err) {
            return console.log(err);
        }
        console.log("Last Page saved!");
    });
}

const requestCallback = function (ip, error, response, html) {
    console.log("ip", ip)
    if (!error) {
        newips.push(ip)
        screenshot(html, ip.replace('http://', '').split('.').join('-') + '.html')
    }
    else {
        console.log("error", error)
    }
    console.log("newips", newips)
}

router.get('/', function (req, res, next) {
    ips.forEach((ip, index) => {
        const options = {
            proxy: ip,
            url: 'https://www.flipkart.com/search?as=off&as-show=on&count=40&otracker=start&p%5B%5D=facets.latest_arrivals%255B%255D%3DLast%2B30%2BDays&p%5B%5D=facets.language%255B%255D%3DTamil&p%5B%5D=sort%3Drelevance&q=books&sid=bks',
        }
        request(options, requestCallback.bind(null, ip))
    })

    res.send('respond ');
});


module.exports = router;
